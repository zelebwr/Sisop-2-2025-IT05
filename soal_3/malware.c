#include <stdio.h> 
#include <stdlib.h>
#include <sys/prctl.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <stdio.h>
#include <stdlib.h>
#include <fcntl.h>
#include <errno.h>
#include <unistd.h>
#include <syslog.h>
#include <string.h>
#include <sys/wait.h>
#include <signal.h>

void selfDestruct(int sig) {
  printf("Self-destructing...\n");
  exit(0);
}

int main() {
  pid_t pid, sid;        // Variabel untuk menyimpan PID

  pid = fork();     // Menyimpan PID dari Child Process

  /* Keluar saat fork gagal
  * (nilai variabel pid < 0) */
  if (pid < 0) {
  exit(EXIT_FAILURE);
  }

  /* Keluar saat fork berhasil
  * (nilai variabel pid adalah PID dari child process) */
  if (pid > 0) {
  exit(EXIT_SUCCESS);
  }

  umask(0);

  sid = setsid();
  if (sid < 0) {
  exit(EXIT_FAILURE);
  }

  if ((chdir("/")) < 0) {
  exit(EXIT_FAILURE);
  }

  close(STDIN_FILENO);
  close(STDOUT_FILENO);
  close(STDERR_FILENO);

  prctl(PR_SET_NAME, "/cobaDulu", NULL, NULL, NULL);

  // safety measure

  /* int max_runs = 5;
  int current_run = 0;
  while (current_run < max_runs) {
    current_run++;
    sleep(30);
  } */

  // daemon pid
  FILE *pid_file = fopen("/tmp/daemon.pid", "w");
  if (pid_file == NULL) {
    perror("Failed to open pid file");
    exit(EXIT_FAILURE);
  }
  fprintf(pid_file, "%d", getpid());
  fclose(pid_file);

  // open log file
  FILE *log_file = fopen("/tmp/daemon.log", "a");
  if (log_file == NULL) {
    perror("Failed to open log file");
    exit(EXIT_FAILURE);
  }
  fprintf(log_file, "Daemon started with PID: %d\n", getpid());
  fclose(log_file);

  // alarm
  signal(SIGALRM, selfDestruct);
  alarm(300); // Set alarm for 5 minutes
  while (1) {
    // Daemon process does nothing, just sleeps
    sleep(30);
  }

  return 0;
}